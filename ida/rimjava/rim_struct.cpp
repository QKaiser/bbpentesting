#include "../idaldr.h"
#include <struct.hpp>
#include "rim_struct.h"

extern segment_t seg_data;
extern segment_t seg_code;

typeinfo_t data_ref;
typeinfo_t code_ref;

void add_byte_fld(struc_t * sptr, char * Name)
{
	add_struc_member(sptr,Name,-1,byteflag(),0,1);
}

void add_word_fld(struc_t * sptr, char * Name)
{
	add_struc_member(sptr,Name,-1,wordflag(),0,2);
}

void add_dword_fld(struc_t * sptr, char * Name)
{
	add_struc_member(sptr,Name,-1,dwrdflag(),0,4);
}

void add_code_ref(struc_t * sptr, char * Name)
{
	add_struc_member(sptr,Name,-1,wordflag() | offflag(),&code_ref,2);
}

void add_data_ref(struc_t * sptr, char * Name)
{
	add_struc_member(sptr,Name,-1,wordflag() | offflag(),&data_ref,2);
}

void makeStruct(ea_t Address, char * StrucName)
{
	doStruct(Address,get_struc_size(get_struc_id(StrucName)),get_struc_id(StrucName));
}

void LoadStructures()
{
	
	data_ref.ri.type = REF_OFF32;
	data_ref.ri.target_present = false;
	data_ref.ri.base = seg_data.startEA;
	data_ref.ri.tdelta = 0;

	
	code_ref.ri.type = REF_OFF32;
	code_ref.ri.target_present = false;
	code_ref.ri.base = seg_code.startEA;
	code_ref.ri.tdelta = 0;
	
	struc_t * sptr=get_struc(add_struc(-1,"DataHeader_s"));
	add_byte_fld(sptr,"Unknown1");
	add_byte_fld(sptr,"Unknown2");
	add_word_fld(sptr,"ClassesCount");
	add_byte_fld(sptr,"ModulesCount");
	add_byte_fld(sptr,"InterfacesCount");
	add_data_ref(sptr,"AppParamsOffs");
	add_data_ref(sptr,"Unknown4");
	add_data_ref(sptr,"Interface1Offs");
	add_data_ref(sptr,"Interface2Offs");
	add_data_ref(sptr,"Unknown5");
	add_data_ref(sptr,"Unknown6");
	add_data_ref(sptr,"ClassDescriptorArray");
	add_data_ref(sptr,"MethodDescriptorArray");
	add_data_ref(sptr,"Unknown7");
	add_data_ref(sptr,"Unknown8");
	add_data_ref(sptr,"ClassesArray");
	add_data_ref(sptr,"ApplicationParams2");
	add_data_ref(sptr,"PropertiesArray");
	add_data_ref(sptr,"Unknown9");
	add_data_ref(sptr,"ConstantsArray");
	add_data_ref(sptr,"DataSectionSize");
	add_word_fld(sptr,"Unknown11");
	add_data_ref(sptr,"Unknown12");
	add_data_ref(sptr,"MainFunctionName");
	add_data_ref(sptr,"Unknown14");
	add_word_fld(sptr,"Unknown15");
	add_word_fld(sptr,"Unknown16");
	add_word_fld(sptr,"Unknown17");

	sptr=get_struc(add_struc(-1,"AppProperty"));
	add_data_ref(sptr,"ProperyName");
	add_word_fld(sptr,"DataSize");
	add_data_ref(sptr,"Data");

	sptr=get_struc(add_struc(-1,"ClassDescriptor"));
	add_word_fld(sptr,"Index");
	add_data_ref(sptr,"PackageName");
	add_data_ref(sptr,"ClassName");
	add_word_fld(sptr,"Unknown");

	sptr=get_struc(add_struc(-1,"MethodDescriptor"));
	add_data_ref(sptr,"ClassDescriptor");
	add_data_ref(sptr,"MethodName");
	add_word_fld(sptr,"Unknown");
}